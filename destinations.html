<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Destinations - Profiles to Airtable</title>
    <meta content="width=device-width, initial-scale=1" name="viewport">
    <link href="./Extract Profiles to Airtable_files/chrome-extension-prop2.webflow.b67937007.css" rel="stylesheet" type="text/css">
    <link href="./Extract Profiles to Airtable_files/666b4ed93e72317ff3029989_Direct to Airtable.png" rel="shortcut icon" type="image/x-icon">
    <link href="./Extract Profiles to Airtable_files/666b4ed93e72317ff3029989_Direct to Airtable.png" rel="apple-touch-icon">
    <style>
        /* Dashboard Layout */
        .dashboard {
            display: flex;
            min-height: 100vh;
        }
        
        /* Sidebar */
        .sidebar {
            width: 250px;
            background-color: #132134;
            color: white;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        .sidebar-top {
            margin-bottom: auto;
        }
        
        .sidebar-logo {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
            padding: 10px;
        }
        
        .sidebar-logo img {
            height: 35px;
            margin-right: 10px;
        }
        
        .sidebar-menu {
            list-style: none;
            padding: 0;
            margin-top: 0;
        }
        
        .sidebar-menu li {
            margin-bottom: 10px;
        }
        
        .sidebar-menu a {
            color: #ffffff;
            text-decoration: none;
            display: flex;
            align-items: center;
            padding: 10px;
            border-radius: 5px;
        }
        
        .sidebar-menu a:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .sidebar-menu a.active {
            background-color: rgba(255, 255, 255, 0.2);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 30px;
            background-color: #f8f9fa;
        }
        
        /* Header */
        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        /* Logout Button */
        .logout-btn {
            color: #ffffff;
            text-decoration: none;
            padding: 10px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .logout-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* Destination specific styles */
        .destination-container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-top: 20px;
        }

        .destination-select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-top: 10px;
            font-size: 16px;
        }

        .connection-status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
            display: none;
        }

        .connection-status.connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .connection-status.not-connected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .connect-button {
            display: none;
            margin-top: 15px;
            background-color: #132134;
            color: white;
            padding: 12px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
        }

        .connect-button:hover {
            background-color: #1f3553;
        }

        /* Add these new styles */
        .airtable-auth-container {
            display: none;
            margin-top: 20px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f8f9fa;
        }

        .airtable-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 10px 0;
            font-size: 16px;
        }

        .validate-button {
            background-color: #132134;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
        }

        .validate-button:hover {
            background-color: #1f3553;
        }

        .auth-message {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            display: none;
        }

        .auth-message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .auth-message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
    <script>
        // Check if user is logged in (reuse from api-keys.html)
        document.addEventListener('DOMContentLoaded', async function() {
            const userEmail = localStorage.getItem('userEmail');
            const token = localStorage.getItem('token');
            const apiKey = localStorage.getItem('apiKey');

            if (!apiKey || !userEmail || !token) {
                window.location.href = 'login.html';
                return;
            }

            // Verify user
            try {
                const response = await fetch('https://api.mixed-marketing-actions.ovh/verify', {
                    method: 'POST',
                    headers: {
                        'x-api-key': 'mV3xihTh7m9ypwEAvrsxmWDwghb52jD5nQfotH44',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user: {
                            email: userEmail
                        },
                        token: token,
                        service_id: '21647ac6-b6a1-4431-a7b6-dd603ed587e3'
                    })
                });

                if (!response.ok) {
                    window.location.href = 'login.html';
                    return;
                }

                const data = await response.json();
                if (!data.verified) {
                    window.location.href = 'login.html';
                }

                // If verification successful, fetch user's destination
                await fetchUserDestination();
            } catch (error) {
                console.error('Error verifying user:', error);
                window.location.href = 'login.html';
            }
        });

        async function fetchUserDestination() {
            const userEmail = localStorage.getItem('userEmail');
            const token = localStorage.getItem('token');

            try {
                const response = await fetch('https://api.mixed-marketing-actions.ovh/query', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': 'mV3xihTh7m9ypwEAvrsxmWDwghb52jD5nQfotH44'
                    },
                    body: JSON.stringify({
                        user: {
                            email: userEmail
                        },
                        service_id: '21647ac6-b6a1-4431-a7b6-dd603ed587e3',
                        token: token,
                        sqlQuery: "SELECT users.option FROM users WHERE users.email = $1 AND users.service_id = $2;",
                        parameters: []
                    })
                });

                const result = await response.json();
                console.log('Destination Response:', result);

                if (result.success && result.data.length > 0) {
                    const userOption = result.data[0].option;
                    const select = document.getElementById('destinationSelect');
                    select.value = userOption || 'excel';
                    handleDestinationChange(select);
                }
            } catch (error) {
                console.error('Error fetching user destination:', error);
            }
        }

        function handleDestinationChange(select) {
            console.log('Destination changed to:', select.value);
            const airtableAuthContainer = document.querySelector('.airtable-auth-container');
            const statusDiv = document.querySelector('.connection-status');
            
            if (select.value === 'airtable') {
                console.log('Showing Airtable auth container');
                statusDiv.style.display = 'none';
                airtableAuthContainer.style.display = 'block';
            } else {
                console.log('Hiding Airtable auth container');
                statusDiv.style.display = 'none';
                airtableAuthContainer.style.display = 'none';
            }
        }

        function handleLogout() {
            localStorage.removeItem('token');
            localStorage.removeItem('apiKey');
            localStorage.removeItem('userEmail');
            window.location.href = '/';
        }

        async function validateAirtableToken() {
            const airtableToken = document.getElementById('airtableToken').value.trim();
            const authMessage = document.querySelector('.auth-message');
            const userEmail = localStorage.getItem('userEmail');
            const token = localStorage.getItem('token');

            if (!airtableToken) {
                authMessage.textContent = 'Please enter your Airtable token';
                authMessage.className = 'auth-message error';
                authMessage.style.display = 'block';
                return;
            }

            try {
                console.log('Sending auth request with:', {
                    email: userEmail,
                    hasToken: !!token,
                    airtableTokenLength: airtableToken.length
                });

                const requestBody = {
                    user: {
                        email: userEmail
                    },
                    token: token,
                    service_id: '21647ac6-b6a1-4431-a7b6-dd603ed587e3',
                    airtable_token: airtableToken
                };

                console.log('Request body:', requestBody);

                const response = await fetch('https://api.mixed-marketing-actions.ovh/action/linkedin_to_airtable/auth', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': 'mV3xihTh7m9ypwEAvrsxmWDwghb52jD5nQfotH44',
                        'Accept': 'application/json',
                        'Origin': window.location.origin
                    },
                    mode: 'cors',
                    body: JSON.stringify(requestBody)
                });

                const result = await response.json();
                console.log('Airtable Auth Response:', {
                    status: response.status,
                    ok: response.ok,
                    result: result
                });

                if (response.ok && result.success) {
                    authMessage.textContent = 'Airtable connection successful!';
                    authMessage.className = 'auth-message success';
                } else {
                    const errorMsg = result.message || result.error || 'Failed to connect to Airtable';
                    authMessage.textContent = errorMsg;
                    authMessage.className = 'auth-message error';
                }
                authMessage.style.display = 'block';

            } catch (error) {
                console.error('Error validating Airtable token:', error);
                authMessage.textContent = 'An error occurred while validating the token. Please check your token and try again.';
                authMessage.className = 'auth-message error';
                authMessage.style.display = 'block';
            }
        }
    </script>
</head>
<body>
    <div class="dashboard">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-top">
                <div class="sidebar-logo">
                    <img src="./Extract Profiles to Airtable_files/666b4ed93e72317ff3029989_Direct to Airtable.png" alt="Logo">
                    <span>Profile to Airtable</span>
                </div>
                <ul class="sidebar-menu">
                    <li><a href="api-keys.html">API Keys</a></li>
                    <li><a href="#" class="active">Destinations</a></li>
                </ul>
            </div>
            <a href="#" class="logout-btn" onclick="handleLogout()">Logout</a>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="content-header">
                <h1>Destinations</h1>
            </div>

            <div class="destination-container">
                <h2>Choose Your Data Destination</h2>
                <select id="destinationSelect" class="destination-select" onchange="handleDestinationChange(this)">
                    <option value="excel">Excel Download</option>
                    <option value="airtable">Airtable</option>
                </select>

                <div class="connection-status"></div>
                
                <!-- Add the new Airtable authentication container -->
                <div class="airtable-auth-container">
                    <h3>Connect to Airtable</h3>
                    <p>Please enter your Airtable API token to connect your account.</p>
                    <input 
                        type="password" 
                        id="airtableToken" 
                        class="airtable-input" 
                        placeholder="Enter your Airtable token"
                    >
                    <button class="validate-button" onclick="validateAirtableToken()">
                        Validate Connection
                    </button>
                    <div class="auth-message"></div>
                </div>
            </div>
        </div>
    </div>
</body>
</html> 