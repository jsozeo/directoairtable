<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Destinations - Profiles to Airtable</title>
    <meta content="width=device-width, initial-scale=1" name="viewport">
    <link href="./Extract Profiles to Airtable_files/chrome-extension-prop2.webflow.b67937007.css" rel="stylesheet" type="text/css">
    <link href="./Extract Profiles to Airtable_files/666b4ed93e72317ff3029989_Direct to Airtable.png" rel="shortcut icon" type="image/x-icon">
    <link href="./Extract Profiles to Airtable_files/666b4ed93e72317ff3029989_Direct to Airtable.png" rel="apple-touch-icon">
    <style>
        /* Dashboard Layout */
        .dashboard {
            display: flex;
            min-height: 100vh;
        }
        
        /* Sidebar */
        .sidebar {
            width: 250px;
            background-color: #132134;
            color: white;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        .sidebar-top {
            margin-bottom: auto;
        }
        
        .sidebar-logo {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
            padding: 10px;
        }
        
        .sidebar-logo img {
            height: 35px;
            margin-right: 10px;
        }
        
        .sidebar-menu {
            list-style: none;
            padding: 0;
            margin-top: 0;
        }
        
        .sidebar-menu li {
            margin-bottom: 10px;
        }
        
        .sidebar-menu a {
            color: #ffffff;
            text-decoration: none;
            display: flex;
            align-items: center;
            padding: 10px;
            border-radius: 5px;
        }
        
        .sidebar-menu a:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .sidebar-menu a.active {
            background-color: rgba(255, 255, 255, 0.2);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 30px;
            background-color: #f8f9fa;
        }
        
        /* Header */
        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        /* Logout Button */
        .logout-btn {
            color: #ffffff;
            text-decoration: none;
            padding: 10px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .logout-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* Destination specific styles */
        .destination-container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-top: 20px;
        }

        .destination-select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-top: 10px;
            font-size: 16px;
        }

        .connection-status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
            display: none;
        }

        .connection-status.connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .connection-status.not-connected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .connect-button {
            display: none;
            margin-top: 15px;
            background-color: #132134;
            color: white;
            padding: 12px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
        }

        .connect-button:hover {
            background-color: #1f3553;
        }

        /* Add these new styles */
        .airtable-auth-container {
            display: none;
            margin-top: 20px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f8f9fa;
        }

        .airtable-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 10px 0;
            font-size: 16px;
        }

        .validate-button {
            background-color: #132134;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
        }

        .validate-button:hover {
            background-color: #1f3553;
        }

        .auth-message {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            display: none;
        }

        .auth-message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .auth-message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* Add these new styles */
        .base-selection-container {
            display: none;
            margin-top: 20px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f8f9fa;
        }

        .base-select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 10px 0;
            font-size: 16px;
        }

        .save-base-button {
            background-color: #132134;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
        }

        .save-base-button:hover {
            background-color: #1f3553;
        }

        /* Add new style for table selection */
        .table-selection-container {
            display: none;
            margin-top: 20px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f8f9fa;
        }

        .table-select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 10px 0;
            font-size: 16px;
        }

        /* Add styles for fields display */
        .fields-info {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
        }

        .fields-info h4 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #495057;
        }

        .fields-info ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .fields-info li {
            padding: 5px 0;
            border-bottom: 1px solid #e9ecef;
            color: #6c757d;
        }

        .fields-info li:last-child {
            border-bottom: none;
        }
    </style>
    <script>
        // Update the dropdown options based on stored destinations
        function updateDestinationDropdown() {
            const destinationSelect = document.getElementById('destinationSelect');
            const storedOptions = JSON.parse(localStorage.getItem('destination_options') || '[]');
            
            // Clear existing options
            destinationSelect.innerHTML = '';
            
            // Add default Excel option
            const excelOption = document.createElement('option');
            excelOption.value = 'excel';
            excelOption.textContent = 'Excel Download';
            destinationSelect.appendChild(excelOption);

            // Add all stored options
            storedOptions.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt.tool;
                option.textContent = opt.displayName;
                option.selected = opt.selected;
                destinationSelect.appendChild(option);
            });
        }

        // Check if user is logged in and verify
        document.addEventListener('DOMContentLoaded', async function() {
            const userEmail = localStorage.getItem('userEmail');
            const token = localStorage.getItem('token');
            const apiKey = localStorage.getItem('apiKey');

            if (!apiKey || !userEmail || !token) {
                window.location.href = 'login.html';
                return;
            }

            try {
                const response = await fetch('https://api.mixed-marketing-actions.ovh/verify', {
                    method: 'POST',
                    headers: {
                        'x-api-key': 'mV3xihTh7m9ypwEAvrsxmWDwghb52jD5nQfotH44',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user: {
                            email: userEmail
                        },
                        token: token,
                        service_id: '21647ac6-b6a1-4431-a7b6-dd603ed587e3'
                    })
                });

                if (!response.ok) {
                    window.location.href = 'login.html';
                    return;
                }

                const data = await response.json();
                console.log('Verify Response:', data);

                if (!data.verified) {
                    window.location.href = 'login.html';
                    return;
                }

                // Store option in localStorage and ensure display names
                if (data.option) {
                    // Add display names if they don't exist
                    data.option.forEach(opt => {
                        if (!opt.displayName) {
                            if (opt.tool === 'airtable') {
                                opt.displayName = `Airtable - ${opt.baseId.name} - ${opt.tableId.name}`;
                            } else if (opt.tool === 'excel') {
                                opt.displayName = 'Excel Download';
                            } else if (opt.tool === 'google_sheets') {
                                opt.displayName = `Google Sheets - ${opt.baseId.name} - ${opt.tableId.name}`;
                            }
                        }
                    });

                    localStorage.setItem('destination_options', JSON.stringify(data.option));
                    
                    // Update dropdown with all options
                    updateDestinationDropdown();

                    // Find the selected tool and show appropriate container
                    const selectedOption = data.option.find(opt => opt.selected);
                    if (selectedOption) {
                        // If it's airtable and we have baseId and tableId, show the container
                        if (selectedOption.tool === 'airtable' && selectedOption.baseId && selectedOption.tableId) {
                            document.querySelector('.airtable-auth-container').style.display = 'block';
                        }
                    }
                }

            } catch (error) {
                console.error('Error verifying user:', error);
                window.location.href = 'login.html';
            }
        });

        function handleDestinationChange(select) {
            console.log('Destination changed to:', select.value);
            const airtableAuthContainer = document.querySelector('.airtable-auth-container');
            const statusDiv = document.querySelector('.connection-status');
            
            if (select.value === 'airtable') {
                console.log('Showing Airtable auth container');
                statusDiv.style.display = 'none';
                airtableAuthContainer.style.display = 'block';
            } else {
                console.log('Hiding Airtable auth container');
                statusDiv.style.display = 'none';
                airtableAuthContainer.style.display = 'none';
            }
        }

        function handleLogout() {
            localStorage.removeItem('token');
            localStorage.removeItem('apiKey');
            localStorage.removeItem('userEmail');
            window.location.href = '/';
        }

        async function validateAirtableToken() {
            const airtableToken = document.getElementById('airtableToken').value.trim();
            const authMessage = document.querySelector('.auth-message');
            const userEmail = localStorage.getItem('userEmail');
            const token = localStorage.getItem('token');

            if (!airtableToken) {
                authMessage.textContent = 'Please enter your Airtable token';
                authMessage.className = 'auth-message error';
                authMessage.style.display = 'block';
                return;
            }

            try {
                const response = await fetch('https://api.mixed-marketing-actions.ovh/action/linkedin_to_airtable/auth', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': '*/*',
                    },
                    body: JSON.stringify({
                        user: {
                            email: userEmail
                        },
                        token: token,
                        service_id: '21647ac6-b6a1-4431-a7b6-dd603ed587e3',
                        airtable_token: airtableToken
                    })
                });

                // Log the raw response details
                console.log('Raw Response:', {
                    status: response.status,
                    statusText: response.statusText,
                    headers: Object.fromEntries(response.headers.entries()),
                    ok: response.ok
                });

                const result = await response.json();
                
                // Log the parsed response data
                console.log('Parsed Response:', {
                    fullResult: result,
                    success: result.success,
                    message: result.message,
                    bases: result.response?.bases
                });

                if (response.ok && result.success) {
                    // Create success message
                    authMessage.innerHTML = `<strong>Airtable connection successful!</strong>`;
                    authMessage.className = 'auth-message success';
                    
                    // Update the select dropdown to keep airtable selected
                    document.getElementById('destinationSelect').value = 'airtable';

                    // Populate and show base selection
                    const baseSelect = document.getElementById('baseSelect');
                    const baseSelectionContainer = document.querySelector('.base-selection-container');
                    
                    // Clear existing options
                    baseSelect.innerHTML = '';
                    
                    // Add bases to dropdown
                    result.response.bases.forEach(base => {
                        const option = document.createElement('option');
                        option.value = base.id;
                        option.textContent = `${base.name} (${base.permissionLevel})`;
                        baseSelect.appendChild(option);
                    });

                    // Show the base selection container
                    baseSelectionContainer.style.display = 'block';
                    
                } else {
                    const errorMsg = result.message || result.error || 'Failed to connect to Airtable';
                    authMessage.textContent = errorMsg;
                    authMessage.className = 'auth-message error';
                    authMessage.style.display = 'block';
                    // Hide base selection if auth failed
                    document.querySelector('.base-selection-container').style.display = 'none';
                }
            } catch (error) {
                console.error('Error validating Airtable token:', error);
                authMessage.textContent = 'An error occurred while validating the token. Please check your token and try again.';
                authMessage.className = 'auth-message error';
                authMessage.style.display = 'block';
                // Hide base selection on error
                document.querySelector('.base-selection-container').style.display = 'none';
            }
        }

        // Move saveSelectedBase outside validateAirtableToken
        async function saveSelectedBase() {
            const baseSelect = document.getElementById('baseSelect');
            const selectedBaseId = baseSelect.value;
            const selectedBaseName = baseSelect.options[baseSelect.selectedIndex].text;
            const userEmail = localStorage.getItem('userEmail');
            const token = localStorage.getItem('token');
            
            try {
                const response = await fetch('https://api.mixed-marketing-actions.ovh/action/linkedin_to_airtable/get_table', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': '*/*'
                    },
                    body: JSON.stringify({
                        baseId: selectedBaseId,
                        user: {
                            email: userEmail
                        },
                        token: token,
                        service_id: '21647ac6-b6a1-4431-a7b6-dd603ed587e3'
                    })
                });

                const result = await response.json();
                console.log('Tables Response:', result);

                if (response.ok && result.success) {
                    // Show success message for base selection
                    const authMessage = document.querySelector('.auth-message');
                    authMessage.innerHTML = `
                        <strong>Base selected successfully!</strong><br>
                        Using base: ${selectedBaseName}
                    `;
                    authMessage.className = 'auth-message success';
                    authMessage.style.display = 'block';

                    // Populate and show table selection
                    const tableSelect = document.getElementById('tableSelect');
                    const tableSelectionContainer = document.querySelector('.table-selection-container');
                    
                    // Clear existing options
                    tableSelect.innerHTML = '';
                    
                    // Add tables to dropdown with their field count
                    result.response.tables.forEach(table => {
                        const option = document.createElement('option');
                        option.value = JSON.stringify({
                            id: table.id,
                            fields: table.fields
                        });
                        option.textContent = `${table.name} (${table.fields.length} fields)`;
                        tableSelect.appendChild(option);
                    });

                    // Store tables data for later use
                    window.tablesData = result.response.tables;

                    // Show the table selection container
                    tableSelectionContainer.style.display = 'block';
                } else {
                    throw new Error(result.message || 'Failed to fetch tables');
                }
            } catch (error) {
                console.error('Error fetching tables:', error);
                const authMessage = document.querySelector('.auth-message');
                authMessage.textContent = 'Failed to fetch tables. Please try again.';
                authMessage.className = 'auth-message error';
                authMessage.style.display = 'block';
                document.querySelector('.table-selection-container').style.display = 'none';
            }
        }

        // Add this new function to show table fields
        function showTableFields(tableId) {
            const table = window.tablesData.find(t => t.id === tableId);
            if (!table) return;

            const fieldsContainer = document.createElement('div');
            fieldsContainer.className = 'fields-info';
            fieldsContainer.innerHTML = `
                <h4>Available Fields:</h4>
                <ul>
                    ${table.fields.map(field => `
                        <li>${field.name} (${field.type})</li>
                    `).join('')}
                </ul>
            `;

            // Update the fields display
            const existingFields = document.querySelector('.fields-info');
            if (existingFields) {
                existingFields.replaceWith(fieldsContainer);
            } else {
                document.querySelector('.table-selection-container').appendChild(fieldsContainer);
            }
        }

        // Update the saveSelectedTable function
        async function saveSelectedTable() {
            const tableSelect = document.getElementById('tableSelect');
            const selectedTableData = JSON.parse(tableSelect.value);
            const baseSelect = document.getElementById('baseSelect');
            const selectedBaseId = baseSelect.value;
            const selectedBaseName = baseSelect.options[baseSelect.selectedIndex].text;
            const selectedTableName = tableSelect.options[tableSelect.selectedIndex].text.split(' (')[0];
            const userEmail = localStorage.getItem('userEmail');
            const token = localStorage.getItem('token');
            
            try {
                // Get existing options from localStorage
                const existingOptions = JSON.parse(localStorage.getItem('destination_options') || '[]');
                
                // Create the new option
                const newOption = {
                    tool: 'airtable',
                    baseId: {
                        name: selectedBaseName,
                        id: selectedBaseId
                    },
                    tableId: {
                        name: selectedTableName,
                        id: selectedTableData.id
                    },
                    selected: true,
                    displayName: `Airtable - ${selectedBaseName} - ${selectedTableName}`
                };

                // Set all existing options to not selected and ensure they have displayNames
                existingOptions.forEach(opt => {
                    opt.selected = false;
                    // Add display name to existing options if they don't have one
                    if (!opt.displayName) {
                        if (opt.tool === 'airtable') {
                            opt.displayName = `Airtable - ${opt.baseId.name} - ${opt.tableId.name}`;
                        } else if (opt.tool === 'excel') {
                            opt.displayName = 'Excel Download';
                        } else if (opt.tool === 'google_sheets') {
                            opt.displayName = `Google Sheets - ${opt.baseId.name} - ${opt.tableId.name}`;
                        }
                    }
                });

                // Find if airtable option exists
                const airtableIndex = existingOptions.findIndex(opt => opt.tool === 'airtable');
                if (airtableIndex !== -1) {
                    // Update existing airtable option
                    existingOptions[airtableIndex] = newOption;
                } else {
                    // Add new airtable option
                    existingOptions.push(newOption);
                }

                // Update localStorage
                localStorage.setItem('destination_options', JSON.stringify(existingOptions));

                // Make API call to destination_selection
                const destinationResponse = await fetch('https://api.mixed-marketing-actions.ovh/action/linkedin_to_airtable/destination_selection', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': '*/*'
                    },
                    body: JSON.stringify({
                        user: {
                            email: userEmail
                        },
                        token: token,
                        service_id: '21647ac6-b6a1-4431-a7b6-dd603ed587e3',
                        option: existingOptions
                    })
                });

                const destinationResult = await destinationResponse.json();
                console.log('Destination Selection Response:', destinationResult);

                if (destinationResponse.ok && destinationResult.success) {
                    // Show success message
                    const authMessage = document.querySelector('.auth-message');
                    authMessage.innerHTML = `
                        <strong>Table configuration saved successfully!</strong><br>
                        Your profiles will be exported to table "${selectedTableName}" in base "${selectedBaseName}".
                    `;
                    authMessage.className = 'auth-message success';
                    authMessage.style.display = 'block';

                    // Show the fields for the selected table
                    showTableFields(selectedTableData.id);
                } else {
                    throw new Error(destinationResult.message || 'Failed to save destination selection');
                }
            } catch (error) {
                console.error('Error saving destination selection:', error);
                const authMessage = document.querySelector('.auth-message');
                authMessage.textContent = 'Failed to save destination selection. Please try again.';
                authMessage.className = 'auth-message error';
                authMessage.style.display = 'block';
            }
        }
    </script>
</head>
<body>
    <div class="dashboard">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-top">
                <div class="sidebar-logo">
                    <img src="./Extract Profiles to Airtable_files/666b4ed93e72317ff3029989_Direct to Airtable.png" alt="Logo">
                    <span>Profile to Airtable</span>
                </div>
                <ul class="sidebar-menu">
                    <li><a href="api-keys.html">API Keys</a></li>
                    <li><a href="#" class="active">Destinations</a></li>
                </ul>
            </div>
            <a href="#" class="logout-btn" onclick="handleLogout()">Logout</a>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="content-header">
                <h1>Destinations</h1>
            </div>

            <div class="destination-container">
                <h2>Choose Your Data Destination</h2>
                <select id="destinationSelect" class="destination-select" onchange="handleDestinationChange(this)">
                    <!-- Options will be populated dynamically -->
                </select>

                <div class="connection-status"></div>
                
                <!-- Add the new Airtable authentication container -->
                <div class="airtable-auth-container">
                    <h3>Connect to Airtable</h3>
                    <p>Please enter your Airtable API token to connect your account.</p>
                    <input 
                        type="password" 
                        id="airtableToken" 
                        class="airtable-input" 
                        placeholder="Enter your Airtable token"
                    >
                    <button class="validate-button" onclick="validateAirtableToken()">
                        Validate Connection
                    </button>
                    <div class="auth-message"></div>
                </div>

                <!-- Add the base selection container -->
                <div class="base-selection-container">
                    <h3>Select Airtable Base</h3>
                    <p>Choose the base you want to use for storing profiles:</p>
                    <select id="baseSelect" class="base-select">
                        <!-- Options will be populated dynamically -->
                    </select>
                    <button class="save-base-button" onclick="saveSelectedBase()">
                        Save Base Selection
                    </button>
                </div>

                <!-- Add the table selection container -->
                <div class="table-selection-container">
                    <h3>Select Airtable Table</h3>
                    <p>Choose the table where you want to store the profiles:</p>
                    <select id="tableSelect" class="table-select">
                        <!-- Options will be populated dynamically -->
                    </select>
                    <button class="save-base-button" onclick="saveSelectedTable()">
                        Save Table Selection
                    </button>
                </div>
            </div>
        </div>
    </div>
</body>
</html> 